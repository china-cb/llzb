<?php
namespace app\index\controller;
use app\core\model\ExecModel;
use app\core\model\PaymentModel;
use app\core\model\PayModel;
use app\index\model\IndexModel;
use app\lib\TisApi;
use app\lib\WisApi;
use PHPMailer\PHPMailer\Exception;
use think\Controller;
use think\Db;

//use Mts\Request\V20140618 as Mts;

/**
 * Created by PhpStorm.
 * User: 冯天元
 * Date: 2016/12/5
 * Time: 13:19
 */
class Index extends CommonIndex
{
    protected $partNum;

    public function __construct()
    {
        parent::__construct();
    }

    /** 玲珑TV首页 */
    public function index()
    {
        return $this->fetch();
    }

    /** 套餐购买 */
    public function package(){

        $this->assign("nav_num","3");
        return $this->fetch();
    }

    /** 购买套餐提交页面 */
    public function package_buy(){
        return $this->fetch();
    }

    /** 支付成功页面 */
    public function pay_success(){
        return $this->fetch();
    }
    /** 获取套餐信息 */
    public function pay_info(){
        $id = input('post.b','');
        $m = new IndexModel();
        $list = $m->get_package_info($id);
        (empty($list)) && wrong_return('套餐信息不正确');
        ok_return('上传成功',1,$list);
    }

    /** 余额支付 */
    public function balance_pay(){
        $order = input('post.order','');
//      $order = '1702031110289780';

        /**获取父级订单信息*/
        $order_m = new PayModel();
        $info = $order_m->get_order_info_by_id($order);

        if (empty($info)) {
            wrong_return('无效订单');
        }
        $rt = $order_m->get_balance_info_by_id($order);
        if(empty($rt)){
            wrong_return('无效购买订单');
        }
        $k1 = $order_m->get_user_money($rt['uid']);

        if($rt['money'] > $k1){
            wrong_return('余额不足');
        }
        $k2 = $k1 - $rt['money'];

        // 启动事务
        Db::startTrans();
        try{
            log_w('余额支付开始。。。。。');
            Db::table('sp_member')->where('member_id',$rt['uid'])->update(['balance' => $k2]);
            /**标记支付成功*/
            $m_exec = new ExecModel();
            $res = $m_exec->set_order_status($order, "2", "1");
            if ($res == 0) throw new Exception('支付失败');
            // 提交事务
            Db::commit();
        } catch (\Exception $e) {
            // 回滚事务
            $e->getMessage();
            Db::rollback();
            wrong_return('支付失败，请重试');
        }

        $info = $order_m->get_order_info_by_id($order);
        if (empty($info)) {
            wrong_return("订单信息获取失败");
        }
        /**业务状态*/
        $pay_status = $info["pay_status"];
        if ($pay_status !== '2') {
            wrong_return("订单状态不正确");
        }
        $m = new PaymentModel();
        $list = $m->open($order);
        if($list['code'] == 1){
            ok_return('支付成功');
        }else{
            wrong_return('支付失败');
        }


    }

    /** 帮助中心 */
    public function help_center(){
        $this->assign("nav_num","4");
        $m = new IndexModel();
        $help_category = $m->get_help_category();
        $help_category_child = $m->get_help_category_child();
        foreach($help_category as $k=>$v){
            $help_category[$k]['child'] = "";
            foreach($help_category_child as $k2=>$v2){
                if($v2['pid'] == $v['id']){
                    $help_category[$k]['child'][] = $v2;
                }
            }
        };
        $this->assign('help_category',$help_category);
        return $this->fetch();
    }


    /** 获取帮助菜单列表 */
    public function get_help_menu_list(){
        $id = input("param.id",'');
        empty($id) && wrong_return("菜单ID不存在");
        $m = new IndexModel();
        $list = $m->get_help_list_do($id);
        $this->assign('list',$list);
        $data = [
            'code'=>1,
            'html'=>$this->fetch()
        ];
        die_json($data);
    }

    /** 获取帮助中心的详细内容 */
    public function get_help_info(){
        $id = input("param.id",'');
        empty($id) && wrong_return("ID不能为空");
        $m = new IndexModel();
        $help_info = $m->get_help_info_by_id($id);
        $this->assign('help_info',$help_info);
        $data = [
            'code'=>1,
            'html'=>$this->fetch()
        ];
        die_json($data);
    }
}